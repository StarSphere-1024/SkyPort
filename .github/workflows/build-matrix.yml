name: Build (Linux packages + Windows portable)

on:
  workflow_call:
    inputs:
      retention-days:
        required: false
        type: number
        default: 7
    outputs:
      app_version:
        description: Extracted application version
        value: ${{ jobs.prepare.outputs.app_version }}

concurrency:
  group: build-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  FLUTTER_CHANNEL: stable

jobs:
  prepare:
    name: Prepare / Extract Version
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Override pubspec version from tag (if tag build)
        if: github.ref_type == 'tag'
        shell: bash
        working-directory: SkyPort
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          VERSION="${TAG_NAME#v}"

          # 使用 GitHub 运行编号作为 build number（在当前 workflow 内单调递增）
          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"

          echo "Using version from tag: $VERSION (+$BUILD_NUMBER)"

          # 覆盖 pubspec.yaml 中的 version 行
          sed -i "s/^version:.*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml

          echo "Updated pubspec.yaml:"
          grep '^version:' pubspec.yaml

      - name: Extract version
        id: version
        shell: bash
        working-directory: SkyPort
        run: |
          APP_VERSION=$(sed -n 's/^[[:space:]]*version:[[:space:]]*\([^+]*\).*/\1/p' pubspec.yaml | head -n 1 | tr -d '\r')
          if [ -z "$APP_VERSION" ]; then
            echo "app_version=unknown" >> "$GITHUB_OUTPUT"
            echo "Detected version: unknown"
          else
            echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"
            echo "Detected version: $APP_VERSION"
          fi

  linux:
    name: Linux Packages
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        ff_job: [linux-deb, linux-appimage]
        include:
          - ff_job: linux-deb
            artifact_suffix: linux-x64-deb
          - ff_job: linux-appimage
            artifact_suffix: linux-x64-appimage
    env:
      APP_VERSION: ${{ needs.prepare.outputs.app_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: System dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev
      - name: Install AppImage tool (appimagetool)
        if: matrix.ff_job == 'linux-appimage'
        run: |
          sudo apt-get install -y libfuse2 || echo "libfuse2 already present"
          curl -L -o appimagetool.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool.AppImage
          sudo mv appimagetool.AppImage /usr/local/bin/appimagetool
          appimagetool --version || echo "appimagetool installed"

      - name: Activate fastforge
        run: dart pub global activate fastforge

      - name: Download Dart/Flutter deps
        working-directory: SkyPort
        run: flutter pub get

      - name: Build (${{ matrix.ff_job }})
        working-directory: SkyPort
        run: fastforge release --name release --jobs ${{ matrix.ff_job }}

      - name: List dist
        working-directory: SkyPort
        run: ls -R dist || echo "dist missing"

      - name: Normalize deb filename
        if: matrix.ff_job == 'linux-deb'
        working-directory: SkyPort
        run: |
          mkdir -p dist/standard
          # fastforge 输出示例：dist/release/1.0.0+1/skyport-1.0.0+1-linux.deb
          DEB_FILE=$(ls dist/release/*/*.deb 2>/dev/null | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "No .deb file found under dist/release/*/*.deb" >&2
            exit 1
          fi
          TARGET="dist/standard/SkyPort-v${APP_VERSION}-linux-amd64.deb"
          cp "$DEB_FILE" "$TARGET"
          echo "Copied $DEB_FILE -> $TARGET"

      - name: Normalize AppImage filename
        if: matrix.ff_job == 'linux-appimage'
        working-directory: SkyPort
        run: |
          mkdir -p dist/standard
          # fastforge 输出示例：dist/release/1.0.0+1/skyport-1.0.0+1-linux.AppImage
          APPIMAGE_FILE=$(ls dist/release/*/*.AppImage 2>/dev/null | head -n 1)
          if [ -z "$APPIMAGE_FILE" ]; then
            echo "No .AppImage file found under dist/release/*/*.AppImage" >&2
            exit 1
          fi
          TARGET="dist/standard/SkyPort-v${APP_VERSION}-linux-amd64.AppImage"
          cp "$APPIMAGE_FILE" "$TARGET"
          echo "Copied $APPIMAGE_FILE -> $TARGET"

      - name: Upload deb artifact
        if: matrix.ff_job == 'linux-deb'
        uses: actions/upload-artifact@v4
        with:
          name: SkyPort-v${{ env.APP_VERSION }}-linux-amd64-deb
          path: SkyPort/dist/standard/SkyPort-v${{ env.APP_VERSION }}-linux-amd64.deb
          retention-days: ${{ inputs.retention-days }}

      - name: Upload AppImage artifact
        if: matrix.ff_job == 'linux-appimage'
        uses: actions/upload-artifact@v4
        with:
          name: SkyPort-v${{ env.APP_VERSION }}-linux-amd64-appimage
          path: SkyPort/dist/standard/SkyPort-v${{ env.APP_VERSION }}-linux-amd64.AppImage
          retention-days: ${{ inputs.retention-days }}

  windows:
    name: Windows (x64, portable & setup)
    needs: prepare
    runs-on: windows-latest
    env:
      APP_VERSION: ${{ needs.prepare.outputs.app_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Cache pub (Windows)
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Pub\Cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Download dependencies
        working-directory: SkyPort
        run: flutter pub get
        shell: pwsh

      - name: Build release
        working-directory: SkyPort
        run: flutter build windows --release
        shell: pwsh

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Build Windows setup installer (Inno Setup)
        working-directory: SkyPort
        shell: pwsh
        run: |
          $BuildDir = (Resolve-Path "build/windows/x64/runner/Release").Path
          if (!(Test-Path $BuildDir)) { Write-Error "Build directory not found: $BuildDir" }

          # 使用已经参数化的 Inno Setup 脚本
          $IssFile = "windows/packaging/exe/inno_setup.iss"
          if (!(Test-Path $IssFile)) { Write-Error "ISS file not found: $IssFile" }

          $Iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (!(Test-Path $Iscc)) { Write-Error "ISCC.exe not found at $Iscc" }

          & $Iscc `
            "/DAPP_VERSION=$Env:APP_VERSION" `
            "/DSOURCE_DIR=$BuildDir" `
            "/DOUTPUT_BASE_FILENAME=SkyPortInstaller" `
            $IssFile

          if ($LASTEXITCODE -ne 0) { Write-Error "Inno Setup compilation failed with exit code $LASTEXITCODE" }

          # 根据 inno_setup.iss 中的 OutputDir=.，安装包会生成在 ISS 所在目录
          $SetupSource = "windows/packaging/exe/SkyPortInstaller.exe"
          if (!(Test-Path $SetupSource)) { Write-Error "Setup source not found: $SetupSource" }

          # 规范化安装包命名：SkyPort-v{version}-windows-amd64-setup.exe
          $SetupTarget = "SkyPort-v$Env:APP_VERSION-windows-amd64-setup.exe"
          Move-Item -Path $SetupSource -Destination $SetupTarget -Force
          Write-Host "Created $SetupTarget"

      - name: Package zip
        working-directory: SkyPort
        shell: pwsh
        run: |
          $PortableDir = "build/windows/x64/runner/Release"
          if (!(Test-Path $PortableDir)) { Write-Error "Portable directory not found: $PortableDir" }
          # SkyPort-v{version}-windows-amd64-portable.zip
          $ZipName = "SkyPort-v$Env:APP_VERSION-windows-amd64-portable.zip"
          Compress-Archive -Path "$PortableDir/*" -DestinationPath $ZipName -Force
          Write-Host "Created $ZipName"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SkyPort-v${{ env.APP_VERSION }}-windows-amd64-portable
          path: SkyPort/SkyPort-v${{ env.APP_VERSION }}-windows-amd64-portable.zip
          retention-days: ${{ inputs.retention-days }}

      - name: Upload Windows setup artifact
        uses: actions/upload-artifact@v4
        with:
          name: SkyPort-v${{ env.APP_VERSION }}-windows-amd64-setup
          path: SkyPort/SkyPort-v${{ env.APP_VERSION }}-windows-amd64-setup.exe
          retention-days: ${{ inputs.retention-days }}

  summary:
    name: Summary
    needs: [linux, windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build matrix result
        run: |
          echo "Linux + Windows jobs finished." \
            && echo "Version: ${{ needs.prepare.outputs.app_version }}" \
            && echo "Linux result: ${{ needs.linux.result }}" \
            && echo "Windows result: ${{ needs.windows.result }}"
