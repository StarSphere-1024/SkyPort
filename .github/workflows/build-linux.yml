name: Build Linux

on:
  workflow_call:
    inputs:
      app_version:
        required: true
        type: string
      retention-days:
        required: false
        type: number
        default: 7

permissions:
  contents: read

env:
  FLUTTER_CHANNEL: stable

jobs:
  linux:
    name: Linux Packages
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        ff_job: [linux-deb, linux-appimage]
        include:
          - ff_job: linux-deb
            artifact_suffix: linux-x64-deb
          - ff_job: linux-appimage
            artifact_suffix: linux-x64-appimage
    env:
      APP_VERSION: ${{ inputs.app_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: System dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev
      - name: Install AppImage tool (appimagetool)
        if: matrix.ff_job == 'linux-appimage'
        run: |
          sudo apt-get install -y libfuse2 || echo "libfuse2 already present"
          curl -L -o appimagetool.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool.AppImage
          sudo mv appimagetool.AppImage /usr/local/bin/appimagetool
          appimagetool --version || echo "appimagetool installed"

      - name: Activate fastforge
        run: dart pub global activate fastforge

      - name: Download Dart/Flutter deps
        working-directory: SkyPort
        run: flutter pub get

      - name: Build (${{ matrix.ff_job }})
        working-directory: SkyPort
        run: fastforge release --name release --jobs ${{ matrix.ff_job }}

      - name: List dist
        working-directory: SkyPort
        run: ls -R dist || echo "dist missing"

      - name: Normalize deb filename
        if: matrix.ff_job == 'linux-deb'
        working-directory: SkyPort
        run: |
          mkdir -p dist/standard
          # fastforge 输出示例：dist/release/1.0.0+1/skyport-1.0.0+1-linux.deb
          DEB_FILE=$(ls dist/release/*/*.deb 2>/dev/null | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "No .deb file found under dist/release/*/*.deb" >&2
            exit 1
          fi
          TARGET="dist/standard/SkyPort-v${APP_VERSION}-linux-amd64.deb"
          cp "$DEB_FILE" "$TARGET"
          echo "Copied $DEB_FILE -> $TARGET"

      - name: Normalize AppImage filename
        if: matrix.ff_job == 'linux-appimage'
        working-directory: SkyPort
        run: |
          mkdir -p dist/standard
          # fastforge 输出示例：dist/release/1.0.0+1/skyport-1.0.0+1-linux.AppImage
          APPIMAGE_FILE=$(ls dist/release/*/*.AppImage 2>/dev/null | head -n 1)
          if [ -z "$APPIMAGE_FILE" ]; then
            echo "No .AppImage file found under dist/release/*/*.AppImage" >&2
            exit 1
          fi
          TARGET="dist/standard/SkyPort-v${APP_VERSION}-linux-amd64.AppImage"
          cp "$APPIMAGE_FILE" "$TARGET"
          echo "Copied $APPIMAGE_FILE -> $TARGET"

      - name: Upload deb artifact
        if: matrix.ff_job == 'linux-deb'
        uses: actions/upload-artifact@v4
        with:
          name: SkyPort-v${{ env.APP_VERSION }}-linux-amd64-deb
          path: SkyPort/dist/standard/SkyPort-v${{ env.APP_VERSION }}-linux-amd64.deb
          retention-days: ${{ inputs.retention-days }}

      - name: Upload AppImage artifact
        if: matrix.ff_job == 'linux-appimage'
        uses: actions/upload-artifact@v4
        with:
          name: SkyPort-v${{ env.APP_VERSION }}-linux-amd64-appimage
          path: SkyPort/dist/standard/SkyPort-v${{ env.APP_VERSION }}-linux-amd64.AppImage
          retention-days: ${{ inputs.retention-days }}
